{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "CAWS Working Spec",
  "type": "object",
  "required": ["id", "title", "risk_tier", "mode", "change_budget", "blast_radius", "operational_rollback_slo", "scope", "invariants", "acceptance", "non_functional", "contracts"],
  "properties": {
    "id": { "type": "string", "pattern": "^[A-Z]+-\\d+$" },
    "title": { "type": "string", "minLength": 8 },
    "risk_tier": { "type": "integer", "enum": [1,2,3] },
    "mode": { "type": "string", "enum": ["refactor", "feature", "fix", "doc", "chore"] },
    "change_budget": {
      "type": "object",
      "properties": {
        "max_files": { "type": "integer", "minimum": 1 },
        "max_loc":   { "type": "integer", "minimum": 1 }
      },
      "required": ["max_files","max_loc"],
      "additionalProperties": false
    },
    "blast_radius": {
      "type": "object",
      "properties": {
        "modules": { "type": "array", "items": { "type": "string" } },
        "data_migration": { "type": "boolean" }
      },
      "required": ["modules","data_migration"],
      "additionalProperties": false
    },
    "operational_rollback_slo": { "type": "string", "pattern": "^[0-9]+m$|^[0-9]+h$" },
    "threats": { "type": "array", "items": { "type": "string" } },
    "scope": {
      "type": "object",
      "required": ["in","out"],
      "properties": {
        "in":  { "type": "array", "items": { "type": "string" }, "minItems": 1 },
        "out": { "type": "array", "items": { "type": "string" } }
      }
    },
    "invariants": { "type": "array", "items": { "type": "string" }, "minItems": 1 },
    "acceptance": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["id","given","when","then"],
        "properties": {
          "id":   { "type": "string", "pattern": "^A\\d+$" },
          "given":{ "type": "string" },
          "when": { "type": "string" },
          "then": { "type": "string" }
        }
      }
    },
    "non_functional": {
      "type": "object",
      "properties": {
        "a11y": { "type": "array", "items": { "type": "string" } },
        "perf": {
          "type": "object",
          "properties": {
            "api_p95_ms": { "type": "integer", "minimum": 1 },
            "lcp_ms": { "type": "integer", "minimum": 1 }
          },
          "additionalProperties": false
        },
        "security": { "type": "array", "items": { "type": "string" } }
      },
      "additionalProperties": false
    },
    "contracts": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["type","path"],
        "properties": {
          "type": { "type": "string", "enum": ["openapi","graphql","proto","pact"] },
          "path": { "type": "string" }
        }
      }
    },
    "observability": {
      "type": "object",
      "properties": {
        "logs":    { "type": "array", "items": { "type": "string" } },
        "metrics": { "type": "array", "items": { "type": "string" } },
        "traces":  { "type": "array", "items": { "type": "string" } }
      }
    },
    "migrations": { "type": "array", "items": { "type": "string" } },
    "rollback":   { "type": "array", "items": { "type": "string" } }
  },
  "additionalProperties": false
}
